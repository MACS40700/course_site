---
title: "Visualizing spatial data I"
author: "MACS 40700 <br /> University of Chicago"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature:
      highlightStyle: magula
      highlightLines: true
      highlightLanguage: r
      ratio: 16:9
      countIncrementalSlides: false
---

```{r setup, include = FALSE, cache = FALSE}
# generate CSS file
library(xaringanthemer)
#rcfss::xaringan_theme()

# source in the default knitr options
source(here::here("R", "slide-opts.R"))
knitr::opts_chunk$set(echo = FALSE)

# enable panelsets and default theme
xaringanExtra::use_panelset()
# ggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))

# load basic packages
library(knitr)
library(here)
library(countdown)
library(patchwork)
```

class: inverse, middle

# Announcements
* Career services event: tonight
* Homework due tomorrow

---

class: inverse, middle

# For today:

- API key: https://docs.stadiamaps.com/tutorials/getting-started-in-r-with-ggmap/#set-up-api-key-authentication 

```r
# install ggmap if necessary
# install.packages("ggmap")
usethis::use_course("MACS40700/spatial")
```

---

## Setup

```{r pkgs, message = FALSE, cache = FALSE, echo = TRUE}
# load packages
library(tidyverse)
library(sf)
library(leaflet)
library(geofacet)
library(rnaturalearth)
library(lubridate)
library(scico)
library(maps)
library(ggmap)
library(rworldmap)
library(taylor)

# set default theme for ggplot2
ggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))

# set default figure parameters for knitr
knitr::opts_chunk$set(
  fig.width = 8, fig.asp = 0.618,
  fig.retina = 2, dpi = 150
)
```

---

## Geospatial visualizations

* Earliest form of information visualizations
* Geospatial data visualizations
* [Google Maps](https://www.google.com/maps)

---

## Not that Jon Snow

```{r echo = FALSE}
include_graphics(path = "https://media.giphy.com/media/3ohzdUi5U8LBb4GD4s/giphy.gif")
```

---

## Dr. John Snow

```{r echo = FALSE, out.width = "50%"}
include_graphics(path = "https://upload.wikimedia.org/wikipedia/commons/thumb/2/27/Snow-cholera-map-1.jpg/2183px-Snow-cholera-map-1.jpg")
```

.footnote[Source: [Wikipedia](https://en.wikipedia.org/wiki/John_Snow)]

---

## Designing modern maps

* Depict spatial features
* Incorporate additional attributes and information
* Major features
    * Scale
    * Projection
    * Symbols

---

## Scale

* Proportion between distances and sizes on a map and their actual distances and sizes on Earth
* Small-scale map
* Large-scale map

---

## Large-scale map

```{r large-scale}
leaflet() %>%
  addTiles()  %>%
  setView(lng = -87.597, lat = 41.787, zoom = 2) 
```


---

## Small-scale map

```{r small-scale}
# establish view, get map, and plot
leaflet() %>%
  setView(lng = -87.597, lat = 41.787, zoom = 16) %>%
  addMarkers(lng=-87.597086, lat=41.785958, popup="You are here") %>%
  addTiles() 
```

---

## Projection

* Process of taking a three-dimensional object and visualizing it on a two-dimensional surface
* No 100% perfect method for this
* Always introduces distortions

--


* Properties of projection methods
    1. Shape
    1. Area
    1. Angles
    1. Distance
    1. Direction

---

## Conformal projections

```{r import-world, include = FALSE}
world <- ne_countries(returnclass = "sf")
```

```{r mercator, dependson = "import-world"}
world %>%
  #st_transform("+proj=merc") %>%
  ggplot() +
  geom_sf() +
  ggtitle("Mercator projection")
```

---

## Equal-area projections

```{r equal-area, dependson = "import-world"}
{
  world %>%
    st_transform("+proj=laea") %>%
    ggplot() +
    geom_sf() +
    ggtitle("Lambert equal area") +
    theme_minimal()#base_size = rcfss::base_size * .7)
} +
  {
    world %>%
      st_transform("+proj=cea") %>%
      ggplot() +
      geom_sf() +
      ggtitle("Equal area cylindrical") +
      theme_minimal()#base_size = rcfss::base_size * .7)
  } +
  plot_layout(ncol = 1, heights = c(5, 5))
```

---

## Mollweide

```{r mollweide, dependson = "import-world"}
world %>%
  st_transform("+proj=moll") %>%
  ggplot() +
  geom_sf() +
  ggtitle("Mollweide projection")
```

---

## Gall-Peters (AKA variant of equal area cylindrical)

```{r gp , dependson = "import-world"}

world %>% 
  st_transform("+proj=cea +lat_ts=45") %>% 
  ggplot() + 
  geom_sf()  +
    ggtitle("Gall Peters projection")  
    

```


---

class: inverse, middle

# raster maps

---

## `ggmap`

- Package for drawing maps using `ggplot2` and **raster** map tiles
- Static image files generated by mapping services
- Focus on incorporating data into existing maps
- Severely limits ability to change the appearance of the geographic map
- Don't have to worry about the maps, just the data to go on top
- **NEED API**

---
## `leaflet` (has both R and javascript availabilty)

- similar to `ggmap` but no API needed! 



---
# Bounding boxes: `leaflet`
  
```{r cache = FALSE, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE
)
```

```{r panelset = TRUE, out.width = "70%", cache = TRUE}
  leaflet() %>%
    fitBounds(-87.936287, 41.679835, -87.447052,42.060835) %>%
    addMarkers(lng=-87.597086, lat=41.785958, popup="You are here") %>%
    setView(lng = -87.597, lat = 41.787, zoom = 8) %>%
    addTiles()  
```



---
## Level of detail: zoom = 12 vs 10

.pull-left[ 
```{r bb-chicago-zoom_l, echo = FALSE, out.width="80%"}
leaflet() %>%
  addTiles()  %>%
  fitBounds(-87.936287, 41.679835, -87.447052,42.060835) %>%
  addMarkers(lng=-87.597086, lat=41.785958, popup="You are here") %>%
  setView(lng = -87.624003, lat = 41.876823, zoom = 12)  
```
]

.pull-right[ 
```{r bb-chicago-zoom_l2, echo = FALSE, out.width="80%"}
leaflet() %>%
  addTiles()  %>%
  fitBounds(-87.936287, 41.679835, -87.447052,42.060835) %>%
  addMarkers(lng=-87.597086, lat=41.785958, popup="You are here") %>%
  setView(lng = -87.624003, lat = 41.876823, zoom = 10)  
```
]


---

## Bounding box: `ggmap`

```{r cache = FALSE, include = FALSE}
knitr::opts_chunk$set(
  echo = TRUE
)
```

```{r panelset = c(output = "Plot", source = "Code"), out.width = "70%"}
chi_bb <- c( left = -87.936287, bottom = 41.679835, right = -87.447052, top = 42.060835) #<<

chicago <- get_stadiamap( bbox = chi_bb, zoom = 11)

ggmap(chicago)
```



---
## Identifying bounding box
  
  > Use [bboxfinder.com](http://bboxfinder.com/#0.000000,0.000000,0.000000,0.000000) to determine the exact longitude/latitude coordinates for the bounding box you wish to obtain.
    
---

## Types of map tiles: Leaflet

```{r maptype, echo = FALSE, out.width = "60%"}
m <- leaflet() %>% addTiles() %>% setView(lng = -87.624003, lat = 41.876823, zoom = 10)  
m
```

---
## B&W
```{r, out.width = "60%"}
m %>% addProviderTiles(providers$CartoDB.Positron)
```

---

## Nat Geo

```{r, out.width = "60%"}
m %>% addProviderTiles(providers$Esri.NatGeoWorldMap)
```

```{r}
leaflet() %>% setView(lng = -87.624003, lat = 41.876823, zoom = 8)  %>% addTiles()%>% 
  addWMSTiles(
    "http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi",
    layers = "nexrad-n0r-900913",
    options = WMSTileOptions(format = "image/png", transparent = TRUE),
    attribution = "Weather data Â© 2012 IEM Nexrad"
  )

```



---
class: inverse, middle
                         
 ```{r echo = FALSE}
 include_graphics(path = "https://media.giphy.com/media/oOK9AZGnf9b0c/giphy.gif")
 ```
                         
                         
---

class: inverse, middle

# Example: using `ggmap`

---
## Import crime data
 
* City of Chicago open data portal
* [Crime data from 2017](https://data.cityofchicago.org/Public-Safety/Crimes-2017/d62x-nvdr)

```{r import-crimes, echo = TRUE}
crimes <- read_csv("data/chicago-crimes.csv")
glimpse(crimes)
```

---

## Plot high-level map of crime

.panelset[
```{r import-chicago, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), out.width = "70%"}
ggmap(chicago) #<<
```
]

---

## Using `geom_point()`

.panelset[
```{r plot-crime-point, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), out.width = "70%"}
ggmap(chicago) +
  geom_point( #<<
    data = crimes, #<<
    mapping = aes( #<<
      x = Longitude, #<<
      y = Latitude #<<
    ) #<<
  ) #<<
```
]

---

## Using `geom_point()`

.panelset[
```{r plot-crime-point-alpha, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), out.width = "70%"}
ggmap(chicago) +
  geom_point(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude
    ),
    size = .25, #<<
    alpha = .01 #<<
  )
```
]

---

## Using `geom_density_2d()`

.panelset[
```{r kde-contour, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), out.width = "70%"}
ggmap(chicago) +
  geom_density_2d( #<<
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude
    )
  )
```
]

---

## Using `stat_density_2d()`

.panelset[
```{r kde-fill, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), out.width = "70%"}
ggmap(chicago) +
  stat_density_2d( #<<
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level) #<<
    ),
    geom = "polygon" #<<
  )
```
]

---

## Using `stat_density_2d()`

.panelset[
```{r plot-crime-density, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), out.width = "70%"}
ggmap(chicago) +
  stat_density_2d(
    data = crimes,
    mapping = aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    alpha = .2, #<<
    bins = 25, #<<
    geom = "polygon"
  )
```
]

---

## Looking for variation

.panelset[
```{r plot-crime-wday, dependson = "import-crimes", panelset = c(output = "Plot", source = "Code"), out.width = "70%"}
ggmap(chicago) +
  stat_density_2d(
    data = crimes %>%
      filter(`Primary Type` %in% c(
        "BURGLARY", "MOTOR VEHICLE THEFT",
        "NARCOTICS", "ROBBERY"
      )),
    mapping = aes(
      x = Longitude,
      y = Latitude,
      fill = stat(level)
    ),
    alpha = .4,
    bins = 10,
    geom = "polygon"
  ) +
  facet_wrap(facets = vars(`Primary Type`)) #<<
```
]

---

## Exercise using `ggmap`: needs API key

- City of Chicago data portal
- 311 service requests
- API key: https://docs.stadiamaps.com/tutorials/getting-started-in-r-with-ggmap/#set-up-api-key-authentication 

```r
# install ggmap if necessary
# install.packages("ggmap")
usethis::use_course("MACS40700/spatial")
```

```{r cache = FALSE, echo = FALSE}
countdown(minutes = 15)
```

---

class: middle, inverse

# Geofaceting

---

```{r echo = FALSE, message = FALSE}
us_state_vaccinations <- read_csv(here::here("11-visualize-spatial-i", "data/us_state_vaccinations.csv"))

us_state_vaccinations <- us_state_vaccinations %>%
  mutate(location = if_else(location == "New York State", "New York", location)) %>%
  filter(location %in% c(state.name, "District of Columbia"))
```

```{r geofacet-state, echo = FALSE, out.width = "90%", fig.width = 12}
ggplot(us_state_vaccinations, aes(x = date, y = people_fully_vaccinated_per_hundred, group = location)) +
  geom_area() +
  facet_geo(facets = vars(location)) +
  scale_y_continuous( #<<
    limits = c(0, 100), #<<
    breaks = c(0, 50, 100), #<<
    minor_breaks = c(25, 75) #<<
    ) + #<<
  scale_x_date(breaks = c(ymd("2021-01-01", "2021-07-01", "2022-01-01")), date_labels = "%b-%y") + #<<
  labs(
    x = NULL, y = NULL,
    title = "Covid-19 vaccination rate in the US",
    subtitle = "Daily number of people fully vaccinated, per hundred",
    caption = "Source: Our World in Data"
  ) +
  theme(
    strip.text.x = element_text(size = 7), #<<
    axis.text = element_text(size = 8), #<<
    plot.title.position = "plot"
  )
```

---

## Daily US vaccine data by state

```{r include = FALSE}
us_state_vaccinations <- read_csv(here::here("11-visualize-spatial-i", "data/us_state_vaccinations.csv"))
```

.small[
```{r eval = FALSE, echo = TRUE}
us_state_vaccinations <- read_csv(here::here("data/us_state_vaccinations.csv"))
```

```{r, echo = TRUE}
glimpse(us_state_vaccinations)
```

]

.footnote[
Source: https://ourworldindata.org/us-states-vaccinations
]

---

## Facet by location

.panelset.sideways[
```{r panelset = c(source = "Code", output = "Plot"), out.width = "95%", fig.width = 12}
ggplot(
  us_state_vaccinations,
  aes(x = date, y = people_fully_vaccinated_per_hundred)
) +
  geom_area() +
  facet_wrap(facets = vars(location)) #<<
```
]

---

## Data cleaning

```{r}
us_state_vaccinations <- us_state_vaccinations %>%
  mutate(location = if_else(location == "New York State", "New York", location)) %>%
  filter(location %in% c(state.name, "District of Columbia"))
```

---

## Geofacet by state

Using `geofacet::facet_geo()`:

.panelset.sideways[
```{r panelset = c(source = "Code", output = "Plot"), out.width = "95%", fig.width = 12}
ggplot(us_state_vaccinations, 
       aes(x = date, y = people_fully_vaccinated_per_hundred)) +
  geom_area() +
  facet_geo(facets = vars(location)) + #<<
  labs(
    x = NULL, y = NULL,
    title = "Covid-19 vaccination rate in the US",
    subtitle = "Daily number of people fully vaccinated, per hundred",
    caption = "Source: Our World in Data"
  )
```
]

---

## Geofacet by state, with improvements

.panelset.sideways[
.panel[.panel-name[Plot]
```{r ref.label = "geofacet-state", echo = FALSE, out.width = "95%", fig.width = 12}
```
]
.panel[.panel-name[Code]
.small[
```{r ref.label = "geofacet-state", fig.show = "hide"}
```
]
]
]

---

## Bring in 2020 Presidential election results

```{r include = FALSE}
election_2020 <- read_csv(here::here("11-visualize-spatial-i", "data/us-election-2020.csv"))
```

```{r eval = FALSE}
election_2020 <- read_csv(here::here("data/us-election-2020.csv"))
```

```{r}
election_2020
```

---

## Geofacet by state, color by presidential election result

.tiny[
.panelset.sideways[
```{r panelset = c(source = "Code", output = "Plot"), out.width = "95%", fig.width = 12, warning = FALSE}
us_state_vaccinations %>%
  left_join(election_2020, by = c("location" = "state")) %>%
  ggplot(aes(x = date, y = people_fully_vaccinated_per_hundred)) +
  geom_area(aes(fill = win)) + #<<
  facet_geo(facets = vars(location)) +
  scale_y_continuous(limits = c(0, 100), breaks = c(0, 50, 100), minor_breaks = c(25, 75)) + #<<
  scale_x_date(breaks = c(ymd("2021-01-01", "2021-07-01", "2022-01-01")), date_labels = "%b") +
  scale_fill_manual(values = c("#2D69A1", "#BD3028")) + #<<
  labs(
    x = NULL, y = NULL,
    title = "Covid-19 vaccination rate in the US",
    subtitle = "Daily number of people fully vaccinated, per hundred",
    caption = "Source: Our World in Data",
    fill = "2020 Presidential\nElection"
  ) +
  theme(
    strip.text.x = element_text(size = 7),
    axis.text = element_text(size = 8),
    plot.title.position = "plot",
    legend.position = c(0.93, 0.15), #<<
    legend.text = element_text(size = 9),  #<<
    legend.title = element_text(size = 11),  #<<
    legend.background = element_rect(color = "gray", size = 0.5)  #<<
  )
```
]
]



---

# Recap

* Homework tomorrow!
* Lots we can do spatially
* Maps can require a LOT and options vary / update all the time